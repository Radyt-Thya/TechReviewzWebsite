@page "/bookmarks"
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@using TechReviewzWebsite.Domain
@inject IDbContextFactory<TechReviewzWebsite.Data.TechReviewzWebsiteContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider

<h3>My Bookmarks</h3>

@if (!IsLoggedIn)
{
    <p>Please log in.</p>
}
else if (Bookmarks.Count == 0)
{
    <p>No bookmarks yet.</p>
}
else
{
    <ul>
        @foreach (var b in Bookmarks)
        {
            <li>
                <strong>@b.Title</strong> (Rating: @b.Rating)
            </li>
        }
    </ul>
}

@code {
    bool IsLoggedIn;
    List<Bookmark> Bookmarks = new();

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        IsLoggedIn = user.Identity?.IsAuthenticated == true;
        if (!IsLoggedIn) return;

        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrWhiteSpace(userId)) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        Bookmarks = await db.Bookmark
            .Where(b => b.UserId == userId)
            .OrderByDescending(b => b.DateCreated)
            .ToListAsync();
    }
}
