@page "/bookmarks/add/{ReviewId:int}"
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@using TechReviewzWebsite.Domain
@inject IDbContextFactory<TechReviewzWebsite.Data.TechReviewzWebsiteContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<h3>Saving bookmark…</h3>

@code {
    [Parameter] public int ReviewId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrEmpty(userIdClaim))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        var exists = await db.Bookmark
      .AnyAsync(b => b.UserId == userIdClaim && b.ReviewId == ReviewId);


        if (!exists)
        {
            var review = await db.Review
            .FirstOrDefaultAsync(r => r.Id == ReviewId);

            db.Bookmark.Add(new Bookmark
            {
                UserId = userIdClaim,
                ReviewId = ReviewId,
                Title = review?.Title,
                DateCreated = DateTime.Now.ToString("yyyy-MM-dd HH:mm"),
                DateUpdated = DateTime.Now.ToString("yyyy-MM-dd HH:mm")
            });


            await db.SaveChangesAsync();
        }

        Navigation.NavigateTo("/bookmarks");
    }
}
