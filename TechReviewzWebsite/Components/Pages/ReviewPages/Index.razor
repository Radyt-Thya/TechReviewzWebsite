@page "/reviews"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using TechReviewzWebsite.Data
@using TechReviewzWebsite.Domain
@implements IAsyncDisposable
@inject IDbContextFactory<TechReviewzWebsite.Data.TechReviewzWebsiteContext> DbFactory

<PageTitle>Products</PageTitle>

<h1><b>Product Reviews</b></h1>

<p>
    <a href="reviews/create">Create New</a>
</p>

<QuickGrid TItem="Review" Class="table" Items="Reviews.AsQueryable()">
    <PropertyColumn Property="review => review.Title" />
    <PropertyColumn Property="review => review.Content" />
    <PropertyColumn Property="review => review.Category" />
    <PropertyColumn Property="review => review.Tag" />
    <PropertyColumn Property="review => review.Rating" />
    <PropertyColumn Property="review => review.DateCreated" />
    <PropertyColumn Property="review => review.DateUpdated" />
    <TemplateColumn Context="review" Title="User">
        <div>@GetAuthorDisplay(review.UserId)</div>
    </TemplateColumn>

    <TemplateColumn Context="review">
        <a href="@($"reviews/edit?id={review.Id}")">Edit</a> |
        <a href="@($"reviews/details?id={review.Id}")">Details</a> |
        <a href="@($"reviews/delete?id={review.Id}")">Delete</a>
    </TemplateColumn>
</QuickGrid>

@code {
    private TechReviewzWebsiteContext context = default!;
    private IList<Review> Reviews = Array.Empty<Review>();
    private IList<TechReviewzWebsiteUser> DomainUsers = Array.Empty<TechReviewzWebsiteUser>();

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    protected override async Task OnInitializedAsync()
    {
        using var ctx = DbFactory.CreateDbContext();
        Reviews = await ctx.Review.AsNoTracking().OrderByDescending(r => r.DateCreated).ToListAsync();

        // load Identity users (TechReviewzWebsiteUser is in TechReviewzWebsite.Data)
        DomainUsers = await ctx.Users.AsNoTracking().ToListAsync();
    }

    private string GetAuthorDisplay(string? userId)
    {
        if (string.IsNullOrEmpty(userId)) return "Unknown";
        var u = DomainUsers.FirstOrDefault(x => x.Id == userId);
        if (u is null) return "Unknown";
        return string.IsNullOrWhiteSpace(u.FirstName) && string.IsNullOrWhiteSpace(u.LastName)
            ? u.UserName ?? "Unknown"
            : $"{u.FirstName} {u.LastName}".Trim();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}


