@page "/connections"
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using TechReviewzWebsite.Components.Account
@using TechReviewzWebsite.Data
@using TechReviewzWebsite.Domain
@inject IDbContextFactory<TechReviewzWebsiteContext> DbFactory
@inject NavigationManager NavigationManager
@inject IdentityUserAccessor UserAccessor

<PageTitle>Connections</PageTitle>

<h3>Followers (@FollowerCount)</h3>
<hr />

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert alert-info">@StatusMessage</div>
}

@* Following count shown at the top (how many people the current user is following) *@
@if (currentUserName is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="mb-3">
        <h3>Following (@FollowingCount)</h3>
        <hr />
    </div>
}

@if (currentUserName is null)
{
    <p><em>Loading...</em></p>
}
else
{
    var followingUsers = users.Where(u => !string.IsNullOrEmpty(u.UserName) && IsFollowing(u.UserName)).ToList();
    if (!followingUsers.Any())
    {
        <div class="text-muted">You are not following anyone yet.</div>
    }
    else
    {
        <div class="list-group mb-4">
            @foreach (var u in followingUsers)
            {
                <div class="list-group-item d-flex justify-content-between align-items-center" id="following-@u.UserName">
                    <div>
                        <strong>@u.UserName</strong>
                        @if (!string.IsNullOrEmpty(u.FirstName) || !string.IsNullOrEmpty(u.LastName))
                        {
                            <div class="small">@($"{u.FirstName} {u.LastName}")</div>
                        }
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-outline-danger" onclick="unfollowUser('@u.UserName', this)">Unfollow</button>
                    </div>
                </div>
            }
        </div>
    }
}

<h3>Connect with other People</h3>
<hr />
@if (currentUserName is null)
{
    <!-- nothing to show -->
}
else
{
    var otherUsers = users
        .Where(u => !string.IsNullOrEmpty(u.UserName) && u.UserName != currentUserName && !IsFollowing(u.UserName))
        .ToList();

    if (!otherUsers.Any())
    {
        <div class="text-muted">No more people to follow.</div>
    }
    else
    {
        <div class="list-group">
            @foreach (var u in otherUsers)
            {
                <div class="list-group-item d-flex justify-content-between align-items-center" id="user-@u.UserName">
                    <div>
                        <strong>@u.UserName</strong>
                        @if (!string.IsNullOrEmpty(u.FirstName) || !string.IsNullOrEmpty(u.LastName))
                        {
                            <div class="small">@($"{u.FirstName} {u.LastName}")</div>
                        }
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="followUser('@u.UserName', this)">Follow</button>
                    </div>
                </div>
            }
        </div>
    }
}

@* include client-side helper that calls the minimal API *@
<script src="/js/follow.js"></script>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private string? currentUserName;
    private IList<TechReviewzWebsiteUser> users = Array.Empty<TechReviewzWebsiteUser>();
    private IList<Connection> connections = Array.Empty<Connection>();
    private string? StatusMessage;

    // computed count of people the current user is following
    private int FollowingCount => connections.Count(c =>
        c.Username == currentUserName &&
        c.Relation == "Follow" &&
        c.Status == "Accepted");

    // computed follower count for the current user
    private int FollowerCount => connections.Count(c =>
        c.TargetUsername == currentUserName &&
        c.Relation == "Follow" &&
        c.Status == "Accepted");

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        using var context = DbFactory.CreateDbContext();

        var currentUser = await UserAccessor.GetRequiredUserAsync(HttpContext);
        currentUserName = currentUser?.UserName;

        users = await context.Users.AsNoTracking().ToListAsync();
        connections = await context.Connection.AsNoTracking().ToListAsync();
    }

    private bool IsFollowing(string targetUsername)
        => connections.Any(c =>
            c.Username == currentUserName &&
            c.TargetUsername == targetUsername &&
            c.Relation == "Follow" &&
            c.Status == "Accepted");
}
