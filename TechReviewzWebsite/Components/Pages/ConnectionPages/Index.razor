@page "/connections"
@using Microsoft.EntityFrameworkCore
@using TechReviewzWebsite.Components.Account
@using TechReviewzWebsite.Data
@using TechReviewzWebsite.Domain
@inject IDbContextFactory<TechReviewzWebsiteContext> DbFactory
@inject NavigationManager NavigationManager
@inject IdentityUserAccessor UserAccessor

<PageTitle>Connections</PageTitle>
<h3>Friends</h3>
<hr />

<h3>Following</h3>
<hr />

<h3>Pending</h3>
<hr />

<h3>Connect with other People</h3>
<hr />

@if (currentUserName is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="list-group">
        @foreach (var u in users)
        {
            if (u.UserName == currentUserName) { continue; }
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>@u.UserName</strong>
                    @if (!string.IsNullOrEmpty(u.FirstName) || !string.IsNullOrEmpty(u.LastName))
                    {
                        <div class="small">@($"{u.FirstName} {u.LastName}")</div>
                    }
                </div>

                <div class="btn-group">
                    @if (IsFollowing(u.UserName!))
                    {
                        <button class="btn btn-secondary" disabled>Following</button>
                    }
                    else
                    {
                        <button class="btn btn-outline-primary" @onclick="() => FollowUser(u.UserName!)">Follow</button>
                    }

                    @if (HasPendingFriendRequest(u.UserName!))
                    {
                        <button class="btn btn-warning" disabled>Request sent</button>
                    }
                    else if (IsFriend(u.UserName!))
                    {
                        <button class="btn btn-secondary" disabled>Friend</button>
                    }
                    else
                    {
                        <button class="btn btn-outline-success" @onclick="() => SendFriendRequest(u.UserName!)">Add friend</button>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private string? currentUserName;
    private IList<TechReviewzWebsiteUser> users = Array.Empty<TechReviewzWebsiteUser>();
    private IList<Connection> connections = Array.Empty<Connection>();

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        var currentUser = await UserAccessor.GetRequiredUserAsync(HttpContext);
        currentUserName = currentUser?.UserName;

        users = await context.Users.AsNoTracking().ToListAsync();
        connections = await context.Connection.AsNoTracking().ToListAsync();
    }

    private bool IsFollowing(string targetUsername)
        => connections.Any(c =>
            c.Username == currentUserName &&
            c.TargetUsername == targetUsername &&
            c.Relation == "Follow" &&
            c.Status == "Accepted");

    private bool HasPendingFriendRequest(string targetUsername)
        => connections.Any(c =>
            c.Username == currentUserName &&
            c.TargetUsername == targetUsername &&
            c.Relation == "Friend" &&
            c.Status == "Pending");

    private bool IsFriend(string targetUsername)
        => connections.Any(c =>
            (c.Username == currentUserName && c.TargetUsername == targetUsername ||
             c.Username == targetUsername && c.TargetUsername == currentUserName)
            && c.Relation == "Friend" && c.Status == "Accepted");

    private async Task FollowUser(string targetUsername)
    {
        if (string.IsNullOrEmpty(currentUserName) || targetUsername == currentUserName) return;

        using var context = DbFactory.CreateDbContext();

        // prevent duplicates
        var exists = await context.Connection
            .AnyAsync(c => c.Username == currentUserName && c.TargetUsername == targetUsername && c.Relation == "Follow");

        if (exists) return;

        context.Connection.Add(new Connection
        {
            Username = currentUserName,
            TargetUsername = targetUsername,
            Relation = "Follow",
            Status = "Accepted",
            ProfilePictureURL = null
        });

        await context.SaveChangesAsync();

        connections = await context.Connection.AsNoTracking().ToListAsync();
        StateHasChanged();
    }

    private async Task SendFriendRequest(string targetUsername)
    {
        if (string.IsNullOrEmpty(currentUserName) || targetUsername == currentUserName) return;

        using var context = DbFactory.CreateDbContext();

        // prevent duplicates
        var exists = await context.Connection
            .AnyAsync(c => c.Username == currentUserName && c.TargetUsername == targetUsername && c.Relation == "Friend");

        if (exists) return;

        context.Connection.Add(new Connection
        {
            Username = currentUserName,
            TargetUsername = targetUsername,
            Relation = "Friend",
            Status = "Pending",
        });

        await context.SaveChangesAsync();

        connections = await context.Connection.AsNoTracking().ToListAsync();
        StateHasChanged();
    }
}
