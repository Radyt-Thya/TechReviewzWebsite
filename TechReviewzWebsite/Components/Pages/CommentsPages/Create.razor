@page "/reviews/{ReviewId:int}/comments/create"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using TechReviewzWebsite.Domain
@inject IDbContextFactory<TechReviewzWebsite.Data.TechReviewzWebsiteContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Add Comment</PageTitle>

<h1>Add Comment</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <EditForm Model="Model" OnValidSubmit="AddComments">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div class="mb-3">
                <label class="form-label">Content</label>
                <InputText @bind-Value="Model.Content" class="form-control" />
                <ValidationMessage For="() => Model.Content" class="text-danger" />
            </div>

            <button class="btn btn-primary" type="submit">Post</button>
        </EditForm>
    </div>
</div>

<a class="btn btn-link" href="@($"/reviews/details?id={ReviewId}")">Cancel</a>

@code {
    [Parameter] public int ReviewId { get; set; }

    private Comments Model { get; set; } = new();

    private async Task AddComments()
    {
        // 1) Auth
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrWhiteSpace(userId))
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        // 2) Validate
        if (string.IsNullOrWhiteSpace(Model.Content))
            return;

        // 3) Save a fresh entity (avoid tracking weirdness)
        var entity = new Comments
        {
            ReviewId = ReviewId,
            UserId = userId,
            Content = Model.Content.Trim(),
            DateCreated = DateTime.Now,
            DateUpdated = DateTime.Now
        };

        await using var context = await DbFactory.CreateDbContextAsync();
        context.Comments.Add(entity);

        var rows = await context.SaveChangesAsync();

        // If nothing saved, something is wrong (constraint/exception would usually throw)
        if (rows <= 0)
            return;

        NavigationManager.NavigateTo($"/reviews/details?id={ReviewId}");
    }
}
